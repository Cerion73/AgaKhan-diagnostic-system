{% extends 'dashboard.html' %}

{% load static %}

{% block content %}
<body>
    <div class="container">
        <div class="signup-card bg-white">
            <h2 class="welcome-text text-center">Welcome</h2>
            <p class="instruction-text text-center">To proceed with the diagnostic process, sign up to your account below:</p>
            
            {% csrf_token %}
            <form id="signupForm">
                <div class="mb-3">
                    <label class="form-label">Name</label>
                    <div class="row g-2">
                        <div class="col">
                            <input type="text" class="form-control" placeholder="First name" name="first_name" required>
                        </div>
                        <div class="col">
                            <input type="text" class="form-control" placeholder="Last name" name="last_name" required>
                        </div>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label">Staff ID</label>
                    <input type="text" class="form-control" name="serial_no" required>
                </div>

                <div class="mb-3">
                    <label class="form-label">Active Phone Number</label>
                    <input type="tel" class="form-control" name="phone" required>
                </div>

                <div class="mb-3">
                    <label class="form-label">Password</label>
                    <input type="password" class="form-control" name="password" required>
                </div>

                <div class="mb-3">
                    <label class="form-label">Confirm Password</label>
                    <input type="password" class="form-control" name="confirm_password" required>
                </div>

                <div class="mb-3">
                    <label class="form-label">Branch</label>
                    <select class="form-select" name="branch" required>
                        <option value="">Select...</option>
                        {% for branch in branches %}
                        <option value="{{ branch.id }}">{{ branch.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="mb-3" style="margin-bottom: 40px;"></div>
                    <label class="form-label">Gender</label>
                    <select class="form-select" name="gender" required  style="margin-bottom: 32px;">
                        <option value="">Select...</option>
                        <option value="F">Female</option>
                        <option value="M">Male</option>
                        <option value="I">Intersex</option>
                        <option value="O">Other</option>
                    </select>
                </div>

                <button type="submit" class="btn btn-primary w-100">Submit</button>
            </form>

            <p class="text-center mt-3">
                Already have an account? <a href="#">Sign in</a>
            </p>
        </div>
    </div>

    <script>
        // Add JavaScript to handle form submission and branch loading

        // Get CSRF token function
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        document.getElementById('signupForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = {
                first_name: e.target.first_name.value,
                last_name: e.target.last_name.value,
                serial_no: e.target.serial_no.value,
                phone: e.target.phone.value,
                password: e.target.password.value,
                confirm_password: e.target.confirm_password.value,
                branch: parseInt(e.target.branch.value),
                gender: e.target.gender.value
            };
            console.log(formData)

            try {
                const response = await fetch('http://localhost:8000/users/signup.html/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken'),
                    },
                    body: JSON.stringify(formData),
                });
                
                console.log(response)
                if (response.ok) {
                    // window.location.href = '/home/';
                    const res = response.body
                    console.log(res)
                } else {
                    const errorData = await response.json();
                    alert(`Error: ${errorData.detail || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred during registration');
            }
        });

        // // Load branches dynamically
        // async function loadBranches() {
        //     const response = await fetch('/api/branches/');
        //     const branches = await response.json();
        //     const select = document.querySelector('select[name="branch"]');
            
        //     branches.forEach(branch => {
        //         const option = document.createElement('option');
        //         option.value = branch.id;
        //         option.textContent = branch.name;
        //         select.appendChild(option);
        //     });
        // }

        // loadBranches();
    </script>
</body>
{% endblock %}
